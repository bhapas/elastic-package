version: '2.3'
services:
{{ $logstash_enabled := fact "logstash_enabled" }}
{{ if eq $logstash_enabled "true" }}
  logstash:
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy
    image: ${LOGSTASH_IMAGE_REF}
    healthcheck:
      test: bin/logstash -t
      interval: 60s
      timeout: 50s
      retries: 5
    command: bash -c 'if [[ ! $(bin/logstash-plugin list) ==  *"logstash-filter-elastic_integration"* ]]; then echo "Missing plugin  logstash-filter-elastic_integration, installing now" && bin/logstash-plugin install  logstash-filter-elastic_integration; fi && bin/logstash -f /usr/share/logstashpipeline/  logstash.conf'
    volumes:
      - "../certs/logstash:/usr/share/logstash/config/certs"
      - "../certs/elasticsearch/cert.pem:/usr/share/logstash/config/certs/elasticsearchpem"
      - "./logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro"
    ports:
       - "127.0.0.1:5044:5044"
       - "127.0.0.1:9600:9600"
    environment:
      - xpack.monitoring.enabled=false
      - ELASTIC_USER=elastic
      - ELASTIC_PASSWORD=changeme
      - ELASTIC_HOSTS=https://127.0.0.1:9200

  logstash_is_ready:
    image: tianon/true
    depends_on:
      logstash:
        condition: service_healthy
{{ end }}
